---
description: Règles générales pour l'ensemble du projet
files: **/*
---

# Règles Générales
- Toujours utiliser un style de code concis et efficace.
- Privilégier la clarté et la lisibilité du code.
- Commenter le code de manière exhaustive, en expliquant le *pourquoi* des choix, pas seulement le *quoi*.
- Utiliser des noms de variables et de fonctions descriptifs.
- Gérer les erreurs de manière robuste avec des messages d'erreur clairs pour l'utilisateur.
- Optimiser le code pour la performance, en particulier les opérations sur la carte et les calculs de surface.
- Toujours considérer l'expérience utilisateur : l'interface doit être intuitive et facile à utiliser.
- S'assurer que le code est facilement maintenable et extensible pour de futures fonctionnalités.

# Authentification et Rôles
- Pour la connexion et la gestion des utilisateurs utiliser une authentification JWT.
- Prévois un rôle administrateur, un rôle concessionnaire et un rôle utilisateur final.
- L'administrateur peut gérer tous les comptes.
- Le concessionnaire à accès aux plans qu'il a fait et peut gérer les utilisateurs finaux.
- Utiliser djangorestframework-simplejwt pour la gestion des tokens.
- Durée de validité des tokens : 60 minutes pour l'accès, 1 jour pour le rafraîchissement.
- L'inscription directe d'utilisateurs est désactivée.
- Seul l'administrateur peut créer de nouveaux utilisateurs via l'interface d'administration.
- Les nouveaux utilisateurs reçoivent un email avec leurs identifiants de connexion temporaires.
- Les utilisateurs doivent changer leur mot de passe à leur première connexion.

# Base de Données
- Utiliser PostgreSQL avec l'extension PostGIS pour les données géospatiales.
- Nom de la base : irrigation_db
- Utilisateur : irrigation_user
- Sécuriser les mots de passe en production.
- Optimiser les requêtes géospatiales avec des index spatiaux.

# API REST
- Utiliser Django REST Framework pour l'API.
- Points d'accès principaux :
  - /api/utilisateurs/ (accessible uniquement aux administrateurs)
  - /api/plans/
  - /api/formes/
  - /api/connexions/
  - /api/annotations/
- Documentation interactive disponible sur /docs/
- Interface de navigation de l'API sur /api-auth/
- Authentification via tokens JWT sur :
  - /api/token/ (obtention)
  - /api/token/refresh/ (rafraîchissement)
- Désactiver les endpoints d'inscription publique
- Restreindre la création d'utilisateurs à l'interface d'administration

# Frontend - Composants
- Utiliser des composants réutilisables autant que possible.
- Séparer clairement la logique de présentation (UI) de la logique métier.
- Utiliser des composants fonctionnels avec des hooks (si applicable au framework choisi).
- Gérer l'état des composants de manière efficace (par exemple, avec un contexte global ou un store si nécessaire).
- Assurer l'accessibilité des composants (WAI-ARIA).
- Créer des composants de formulaire qui gèrent la validation et l'affichage des erreurs.

# Frontend - Carte et Formes
- Privilégier la librairie Leaflet pour la gestion des formes.
- Minimiser la quantité de librairies tierces pour éviter les conflits et faciliter la maintenance.
- Toujours avoir une solution simple et intuitive pour dessiner les formes et établir des connexions.
- Permettre le dessin de formes géométriques : rectangles, cercles, demi-cercles, lignes.
- Calculer et afficher les dimensions (longueurs, rayons) et les surfaces des formes dessinées.
- Gérer les interactions de l'utilisateur (clic, glisser-déposer) de manière fluide.
- Permettre le zoom et le déplacement sur la carte.
- Afficher un profil altimétrique pour les lignes.
- Intégrer une fonctionnalité de connexion de formes entre elles.
- Intégrer un fond de carte (utiliser OpenStreetMap par défaut).

# Frontend - Style
- Utiliser un framework CSS moderne (tailwind, bootstrap...)
- Privilégier un design minimaliste et épuré
- Assurer la compatibilité responsive (mobile, tablette, desktop)

# Backend - API
- Utiliser une architecture RESTful.
- Définir des routes claires et bien documentées.
- Valider les données d'entrée de manière exhaustive.
- Gérer l'authentification et l'autorisation des utilisateurs.
- Utiliser des codes de statut HTTP appropriés.
- Retourner des données au format JSON.
- Gérer les erreurs de manière cohérente (codes d'erreur, messages).
- Optimiser les performances de l'API.

# Backend - Base de données
- Utiliser PostgreSQL avec PostGIS pour les données géospatiales.
- Définir un schéma de base de données clair et optimisé.
- Utiliser l'ORM Django pour simplifier l'interaction avec la base de données.
- Assurer la sécurité des données (prévention des injections SQL, etc.).
- Gérer les migrations de schéma de manière propre.
- Optimiser les requêtes pour la performance.

# Développement
- Utiliser le Makefile pour les commandes courantes :
  - make install : Installation des dépendances
  - make migrations : Création des migrations
  - make migrate : Application des migrations
  - make run : Lancement du serveur
  - make test : Exécution des tests
  - make shell : Shell Django
  - make clean : Nettoyage des fichiers compilés
  - make format : Formatage du code

# Sécurité
- Ne jamais exposer les clés secrètes en production
- Utiliser des variables d'environnement pour les configurations sensibles
- Activer CORS uniquement pour les domaines nécessaires
- Valider toutes les entrées utilisateur
- Utiliser HTTPS en production
- Mettre en place une politique de mots de passe robuste
- Désactiver l'inscription publique d'utilisateurs
- Implémenter un système de journalisation des actions administratives
- Mettre en place un système de notification par email pour les actions sensibles
- Limiter les tentatives de connexion échouées

# Tests
- Écrire des tests unitaires pour les fonctionnalités critiques
- Utiliser pytest pour les tests
- Maintenir une couverture de code satisfaisante
- Tester les cas limites et les erreurs

# Documentation
- Maintenir une documentation à jour pour l'API (/docs/)
- Documenter les choix d'architecture
- Commenter le code de manière pertinente
- Fournir des exemples d'utilisation

# Configurateur
## Formes Géométriques
- Types de formes disponibles :
  - Rectangle
  - Cercle
  - Demi-cercle
  - Ligne
- Toutes les formes doivent être modifiables (taille, position, rotation)
- Assurer une interaction fluide pour la modification des formes

## Connexions et Relations
- Permettre la création de connexions entre différentes formes
- Supporter les connexions entre tous les types de formes (ex: demi-cercle vers rectangle)
- Visualisation claire des connexions sur le plan

## Mesures et Calculs
- Affichage automatique des dimensions des formes
- Calcul et affichage en temps réel des surfaces :
  - Surfaces intérieures
  - Surfaces extérieures
- Mise à jour dynamique des mesures lors des modifications

## Profil Altimétrique
- Intégration d'un système de profil altimétrique
- Interface similaire à Google Earth/Géoportail
- Affichage des variations d'altitude le long des lignes
- Visualisation claire des dénivelés

## Annotations et Textes
- Système d'ajout de textes sur les plans
- Options de formatage du texte
- Positionnement libre des annotations
- Rotation possible des textes

## Gestion des Plans
- Système de sauvegarde automatique
- Historique des modifications
- Export au format PDF avec synthèse complète :
  - Visualisation du plan
  - Mesures et calculs
  - Liste des formes et connexions
  - Annotations

## Interface Utilisateur
- Design minimaliste et intuitif
- Utilisation possible sans formation préalable
- Organisation claire des outils et fonctionnalités
- Retours visuels sur les actions utilisateur
- Messages d'aide contextuels

## Niveaux d'Accès
- Admin Général (Usine) :
  - Accès complet à toutes les fonctionnalités
  - Gestion des concessionnaires
  - Supervision globale
- Concessionnaire :
  - Administration de ses clients spécifiques
  - Accès aux plans de ses clients
  - Gestion des utilisateurs finaux
- Utilisateur Final :
  - Sélection obligatoire d'un concessionnaire
  - Création et modification de ses propres plans
  - Accès limité aux fonctionnalités de base

# Structure du Projet
## Organisation des Dossiers
- `api/` : Gestion des endpoints REST et modèles principaux
- `authentication/` : Gestion de l'authentification et des utilisateurs
- `plans/` : Modèles et logique pour les plans d'irrigation
- `templates/` : Templates Django, notamment pour le SPA Vue.js
- `frontend/irrigationdesign/` : Application Vue.js
- `irrigation_design/` : Configuration principale Django

## Modèles de Données
### Utilisateurs (`api/models.py`)
- Trois rôles : admin, dealer (concessionnaire), client
- Champs spécifiques :
  - `role` : Type d'utilisateur
  - `concessionnaire` : Lien vers le concessionnaire (pour les clients)
  - `must_change_password` : Indicateur de changement de mot de passe obligatoire
  - `company_name` : Nom de l'entreprise
  - `phone` : Numéro de téléphone

### Plans (`plans/models.py`)
- `Plan` : Structure principale d'un plan d'irrigation
  - Nom, description, dates de création/modification
  - Lien vers le créateur
- `FormeGeometrique` : Formes géométriques sur le plan
  - Types : Rectangle, Cercle, Demi-cercle, Ligne
  - Géométrie (PostGIS)
  - Surface calculée
  - Propriétés spécifiques en JSON
- `Connexion` : Liens entre formes
  - Forme source et destination
  - Géométrie de la connexion (LineString)
- `TexteAnnotation` : Annotations textuelles
  - Position (Point)
  - Rotation
  - Texte

## API REST (`api/views.py`, `api/urls.py`)
### Points d'Accès
- `/api/users/` : Gestion des utilisateurs
- `/api/dealers/` : Gestion des concessionnaires
- `/api/clients/` : Gestion des clients
- `/api/plans/` : Gestion des plans
- `/api/formes/` : Gestion des formes géométriques
- `/api/connexions/` : Gestion des connexions
- `/api/annotations/` : Gestion des annotations

### Permissions
- Admin : Accès complet à tous les endpoints
- Dealer : 
  - Accès à ses clients
  - Accès aux plans de ses clients
  - Création de clients
- Client :
  - Accès à ses propres données
  - Création et modification de ses plans

## Frontend (Vue.js)
### Routes Principales
- `/` : Vue principale (authentification requise)
- `/projects` : Liste des projets
- `/profile` : Profil utilisateur
- `/settings` : Paramètres
- `/login` : Connexion
- `/forgot-password` : Récupération de mot de passe
- `/reset-password/:token` : Réinitialisation de mot de passe
- `/change-password` : Changement de mot de passe

### Sécurité
- Authentification JWT
- Durée des tokens :
  - Access : 60 minutes
  - Refresh : 1 jour
- Routes protégées avec guards Vue Router
- Vérification du changement de mot de passe obligatoire

## Développement
### Commandes Make
- `make install` : Installation des dépendances
- `make dev` : Lancement des serveurs de développement
- `make frontend` : Build du frontend
- `make collectstatic` : Collecte des fichiers statiques
- `make clean-static` : Nettoyage des fichiers statiques
- `make migrations` : Création des migrations
- `make migrate` : Application des migrations

### Configuration
- Base de données : PostgreSQL avec PostGIS
- Serveur de développement : Django (8000) + Vite (5173)
- Proxy Vite configuré pour `/api` et `/media`
- CORS configuré pour les domaines de développement

## Déploiement
### Fichiers Statiques
- Build dans `static/frontend/`
- Assets dans `static/frontend/assets/`
- Collecte dans `staticfiles/`

### Sécurité
- Debug désactivé en production
- HTTPS requis
- Variables d'environnement pour les secrets
- CORS limité aux domaines autorisés

# Spécifications Techniques
## Frontend
### Dépendances Principales
- Vue.js 3.4+ avec Composition API
- Vue Router 4.2+ pour le routage
- Pinia pour la gestion d'état
- Leaflet avec plugins :
  - @geoman-io/leaflet-geoman-free
  - @raruto/leaflet-elevation
  - leaflet-draw
  - leaflet-geometryutil
  - leaflet-semicircle
- TailwindCSS 3.4+ pour le style
- Axios pour les requêtes HTTP
- TypeScript pour le typage statique

### Configuration TailwindCSS
- Thème personnalisé :
  - Palette de couleurs primary
  - Espacements personnalisés
  - Indices z personnalisés
  - Ombres personnalisées
- Plugins :
  - @tailwindcss/forms
  - @tailwindcss/typography

### Scripts NPM
- `dev` : Développement avec Vite
- `build` : Build de production
- `test:unit` : Tests unitaires avec Vitest
- `test:e2e` : Tests end-to-end avec Cypress
- `lint` : Linting avec ESLint
- `format` : Formatage avec Prettier

## Backend
### Dépendances Principales
- Django 5.1+
- Django REST Framework 3.15+
- DRF GIS 1.0+ pour les fonctionnalités géospatiales
- Simple JWT 5.3+ pour l'authentification
- CORS Headers 4.7+ pour la gestion CORS
- PostgreSQL avec PostGIS
- Python-dotenv pour la gestion des variables d'environnement

### Outils de Développement
- Black pour le formatage
- Flake8 pour le linting
- Pytest pour les tests
- Coverage pour la couverture de code

# Structure Frontend Détaillée
## Composants Vue.js
### Composants Principaux
- `MapContainer.vue` : Conteneur principal de la carte
- `MapComponent.vue` : Composant de carte Leaflet
- `ElevationProfile.vue` : Profil d'élévation
- `ShapeInfo.vue` : Informations sur les formes
- `SearchBar.vue` : Barre de recherche
- `TextAnnotation.vue` : Annotations textuelles
- `Sidebar.vue` : Barre latérale

### Composants d'Authentification
- Dossier `auth/` pour les composants liés à l'authentification
- Gestion des formulaires de connexion/inscription
- Composants de changement de mot de passe

### Tests
- Dossier `__tests__/` pour les tests unitaires
- Tests des composants individuels
- Tests d'intégration

## Stores Pinia
### Store d'Authentification (`auth.ts`)
- Gestion de l'état de connexion
- Stockage des informations utilisateur
- Gestion des tokens JWT
- Actions d'authentification

### Store d'Irrigation (`irrigation.ts`)
- Gestion des plans d'irrigation
- État des formes géométriques
- Actions de modification du plan
- Gestion des connexions

## Organisation du Code Frontend
### Structure des Dossiers
- `components/` : Composants réutilisables
- `views/` : Pages de l'application
- `stores/` : Stores Pinia
- `router/` : Configuration du routeur
- `assets/` : Ressources statiques
- `types/` : Types TypeScript
- `utils/` : Fonctions utilitaires

### Conventions de Nommage
- Composants : PascalCase
- Fichiers de store : camelCase
- Fichiers de test : `.spec.ts` ou `.test.ts`
- Types : Interface{NomType}

### Pratiques de Développement
- Utiliser la Composition API
- Typer strictement avec TypeScript
- Documenter les props et les émissions
- Tester les composants critiques
- Utiliser les composables pour la logique réutilisable
